{% extends "demowebsite/base.html" %}
{% load static shared_tags %}

{% block title %}DTI clustering task #{{ object.name }}-{{ object.id }}{% endblock %}

{% block content %}
<script type="text/javascript" src="{% static "js/build.js" %}"></script>

<div class="centerwrap">
    {% if request.user.is_authenticated %}<p class="breadcrumbs"><a href="{% url "dticlustering:list" %}">&lt; clustering list</a></p>{% endif %}
    <h1>DTI Clustering <span class="id-main">{{ object.name }}-{{ object.id|uuid_prefix }}</span><span class="id-suffix">{{ object.id|uuid_suffix }}</span></h1>
    <p>Requested by {{ object.requested_by }} on dataset <span class="id-main">{{ object.dataset.name }}-{{ object.dataset.id|uuid_prefix }}</span><span class="id-suffix">{{ object.dataset.id|uuid_suffix }}</span></p>
    <p>
        {% if not object.is_finished %}<a href="{% url "dticlustering:cancel" object.id %}" class="btn"><span class="iconify" data-icon="mdi:close-circle"></span> <span>Cancel</span></a> {% endif %}
        <a class="btn is-outline" href="{{ object.dataset.zip_file.url }}"><span class="iconify" data-icon="mdi:folder-download"></span> <span>Download dataset</span></a>
        {% if object.is_finished %}<a href="{% url "dticlustering:restart" object.id %}" class="btn"><span class="iconify" data-icon="mdi:clock-start"></span> <span>Start new clustering with same dataset</span></a>{% endif %}
    </p>
    <pre>Parameters : {{ object.parameters }}</pre>

    {% if object.is_finished %}
    <p>Status: {{ object.status }}</p>

    {% if object.full_log %}<pre>{{ object.full_log }}</pre>{% endif %}

    {% if object.expanded_results %}
    <h2>Results</h2>
    <p>
    {% if object.result_zip_exists %}<a href="{{ object.result_zip_url }}" class="btn is-outline"><span class="iconify" data-icon="mdi:folder-download"></span> <span>Download results</span></a>{% endif %}
    {% if object.expanded_results.csv_export_file %}
    <a href="{{ object.expanded_results.base_url}}{{ object.expanded_results.csv_export_file }}" class="btn is-outline"><span class="iconify" data-icon="mdi:folder-download"></span> <span>Export as csv</span></a>
    {% endif %}
    </p>
    <h3>Manually edited clusterings:</h3>
    <ul class="cl-saved-list">
        {% for clustering in object.saved_clustering.all %}
        <li><a href="{% url "dticlustering:saved" object.pk clustering.pk %}">
            <span class="cl-saved-name">{{ clustering.name }}</span>
            <span class="cl-saved-id">{{ clustering.pk }}</span>
            <span class="cl-saved-date">Edited on {{ clustering.date }}</span></a></li>
        {% empty %}
        <li>No saved clustering</li>
        {% endfor %}
        <li><a href="{% url "dticlustering:saved_create" object.pk %}" class="btn"><span class="iconify" data-icon="mdi:edit"></span> <span>Edit the result in a new file</span></a></li>
    </ul>
</div>

<div id="result" class="cluster-viewer"></div>
    {{ object.expanded_results|json_script:"result_data" }}
    <script type="text/javascript">
        let result_data = JSON.parse(document.getElementById("result_data").textContent);
        DemoTools.initClusterViewer(document.getElementById("result"), result_data, "{{ object.result_media_url|escapejs }}/");
    </script>
    {% endif %}

    {% else %}

        <div id="tracking">
            <p>Status: {{ object.status }}</p>
        </div>
        
        <script type="text/javascript">
            DemoTools.initProgressTracker(document.getElementById("tracking"), "{% url "dticlustering:progress" object.id %}");
        </script>

    {% endif %}
</div>
{% endblock %}