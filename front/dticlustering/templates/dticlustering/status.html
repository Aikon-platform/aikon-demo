{% extends "demowebsite/base.html" %}
{% load static %}

{% block title %}DTI clustering task #{{ object.name }}-{{ object.id }}{% endblock %}

{% block content %}
<div class="centerwrap">
    {% if request.user.is_authenticated %}<p class="breadcrumbs"><a href="{% url "dticlustering:list" %}">&lt; clustering list</a></p>{% endif %}
    <h1>DTI Clustering #{{ object.name }}-{{ object.id }}</h1>
    <p>
        {% if not object.is_finished %}<a href="{% url "dticlustering:cancel" object.id %}">Cancel</a> - {% endif %}
        <a href="{{ object.dataset.zip_file.url }}">Download dataset</a>
        {% if object.is_finished %}- <a href="{% url "dticlustering:restart" object.id %}">Start new clustering with same dataset</a>{% endif %}
    </p>
    <pre>Parameters : {{ object.parameters }}</pre>

    {% if object.is_finished %}
    <p>Status: {{ object.status }}</p>

    {% if object.full_log %}<pre>{{ object.full_log }}</pre>{% endif %}

    {% if object.expanded_results %}
    <h2>Results</h2>
    <p>
    {% if object.result_zip_exists %}<a href="{{ object.result_zip_url }}">Download results</a>{% endif %}
    {% if object.expanded_results.cluster_by_path %}
        - <a href="{{ object.expanded_results.base_url}}{{ object.expanded_results.cluster_by_path }}">Export cluster assignation as csv</a>
    {% endif %}
    </p>
    <h3>Manually edited clusterings:</h3>
    <ul>
        {% for clustering in object.saved_clustering.all %}
        <li><a href="{% url "dticlustering:saved" object.pk clustering.pk %}">{{ clustering.pk }} (Edited on {{ clustering.date }})</a></li>
        {% empty %}
        <li>No saved clustering</li>
        {% endfor %}
        <li><a href="{% url "dticlustering:saved_create" object.pk %}">-&gt; Edit the result in a new file</a></li>
    </ul>
</div>

<div id="result" class="cluster-viewer"></div>
    {{ object.expanded_results|json_script:"result_data" }}
    <script type="text/javascript" src="{% static "dist/build.js" %}"></script>
    <script type="text/javascript">
        let result_data = JSON.parse(document.getElementById("result_data").textContent);
        DemoTools.initClusterViewer(document.getElementById("result"), result_data, "{{ object.result_media_url|escapejs }}/");
    </script>
    {% endif %}

    {% else %}

        <p>Status: <span id="status-value">{{ object.status }}</span></p>
        <div id="progress-wrapper"></div>
        <pre id="status"></pre>
        <script type="text/javascript">
            let $status = document.getElementById("status");
            let $status_string = document.getElementById("status-value");
            let $progress_wrapper = document.getElementById("progress-wrapper");
            const PROGRESS_URL = "{% url "dticlustering:progress" object.id %}";
            // refresh regularly with fetch
            function refresh() {
                fetch(PROGRESS_URL)
                    .then(response => {setTimeout(refresh, 2000); return response.json()})
                    .then(data => {
                        try {
                            $status_string.innerText = data.status;
                            if (data.status == "PENDING") {
                                $status.innerHTML = "\nWaiting for a worker...";
                                return;
                            }
                            $status.innerHTML = data.log.infos.join("\n");
                            $progress_wrapper.innerHTML = "";

                            if (data.log.progress)
                                for (let progress of data.log.progress) {
                                    let $bar_wrapper = document.createElement("div");
                                    
                                    let $label = document.createElement("span");
                                    $label.classList.add("label");
                                    $label.innerHTML = progress.context + " " + progress.current + "/" + progress.total;
                                    $bar_wrapper.appendChild($label);

                                    let $bar = document.createElement("progress");
                                    $bar.classList.add("bar");
                                    $bar.value = progress.current;
                                    $bar.max = progress.total;
                                    $bar_wrapper.appendChild($bar);
                                    
                                    $progress_wrapper.appendChild($bar_wrapper);
                                }
                        } catch (e){
                            $status.innerHTML = JSON.stringify(data);
                        }
                        if (data.is_finished) {
                            window.location.reload();
                        }
                    });
            }
            refresh();
        </script>

    {% endif %}
</div>
{% endblock %}