{% extends "demowebsite/base.html" %}
{% load static %}

{% block title %}DTI clustering task #{{ object.name }}-{{ object.id }}{% endblock %}

{% block content %}
<script type="text/javascript" src="{% static "dist/build.js" %}"></script>

<div class="centerwrap">
    {% if request.user.is_authenticated %}<p class="breadcrumbs"><a href="{% url "dticlustering:list" %}">&lt; clustering list</a></p>{% endif %}
    <h1>DTI Clustering #{{ object.name }}-{{ object.id }}</h1>
    <p>
        {% if not object.is_finished %}<a href="{% url "dticlustering:cancel" object.id %}">Cancel</a> - {% endif %}
        <a href="{{ object.dataset.zip_file.url }}">Download dataset</a>
        {% if object.is_finished %}- <a href="{% url "dticlustering:restart" object.id %}">Start new clustering with same dataset</a>{% endif %}
    </p>
    <pre>Parameters : {{ object.parameters }}</pre>

    {% if object.is_finished %}
    <p>Status: {{ object.status }}</p>

    {% if object.full_log %}<pre>{{ object.full_log }}</pre>{% endif %}

    {% if object.expanded_results %}
    <h2>Results</h2>
    <p>
    {% if object.result_zip_exists %}<a href="{{ object.result_zip_url }}">Download results</a>{% endif %}
    {% if object.expanded_results.cluster_by_path %}
        - <a href="{{ object.expanded_results.base_url}}{{ object.expanded_results.cluster_by_path }}">Export cluster assignation as csv</a>
    {% endif %}
    </p>
    <h3>Manually edited clusterings:</h3>
    <ul>
        {% for clustering in object.saved_clustering.all %}
        <li><a href="{% url "dticlustering:saved" object.pk clustering.pk %}">{{ clustering.pk }} (Edited on {{ clustering.date }})</a></li>
        {% empty %}
        <li>No saved clustering</li>
        {% endfor %}
        <li><a href="{% url "dticlustering:saved_create" object.pk %}">-&gt; Edit the result in a new file</a></li>
    </ul>
</div>

<div id="result" class="cluster-viewer"></div>
    {{ object.expanded_results|json_script:"result_data" }}
    <script type="text/javascript">
        let result_data = JSON.parse(document.getElementById("result_data").textContent);
        DemoTools.initClusterViewer(document.getElementById("result"), result_data, "{{ object.result_media_url|escapejs }}/");
    </script>
    {% endif %}

    {% else %}

        <div id="tracking">
            <p>Status: {{ object.status }}</p>
        </div>
        
        <script type="text/javascript">
            DemoTools.initProgressTracker(document.getElementById("tracking"), "{% url "dticlustering:progress" object.id %}");
        </script>

    {% endif %}
</div>
{% endblock %}