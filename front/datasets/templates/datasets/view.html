{% extends "demowebsite/base.html" %}
{% load shared_tags %}

{% block title %}Dataset {{ dataset.id }}{% endblock %}

{% block content %}
<div class="centerwrap">
    <h1 class="is-title is-size-2 py-3">
        <span class="id-main">Dataset {{ dataset.name }}</span>
        <span class="id-suffix">{{ dataset.id }}</span></h1>

    <div class="">
        <h2>Dataset contents</h2>
    </div>

    <div class="">
        <h2>Applied tasks ({{ dataset.tasks|length }})</h2>
        <div class="tabs is-centered is-normal">
            <ul>
                {% for prefix, tasks in dataset.tasks_by_prefix %}
                    <li id="task-tab-{{ prefix }}"
                        class="tab-prefix
                            {% if dataset.tasks_by_prefix.0.0 == prefix %}
                                is-active
                            {% endif %}"
                    >
                        <a>{{prefix}} ({{ tasks|length }} tasks)</a>
                    </li>
                {% endfor %}
            </ul>
        </div>
        <!-- TODO find a better way to style than inline CSS -->
        <ul style="list-style: none;
                   padding-left: 0;
                   margin-bottom: 0;
                   margin-top: 0;"
        >
            {% for prefix, tasks in dataset.tasks_by_prefix %}
                <li id="{{prefix}}-tasks"
                    class="task-group
                        {% if dataset.tasks_by_prefix.0.0 != prefix %}
                            is-hidden
                        {% endif %}"
                >
                    {#<h3>{{prefix}} ({{ tasks|length }} tasks)</h3></dt>#}
{# TODO generalize "tasking/templates/includes/list-item.html" #}
{# so it can be used here ? what's below is just a cheap copy of it #}
                    <ul>
                        {% for task in tasks %}
                            <li class="task-list"><div class="row columns">
                                <div class="column task-ref is-10 p">
                                    <h4 class="task-ref">
                                        <a href="{{ task.get_absolute_url }}">
                                            <span class="id-main">{{ task }}</span>
                                            <span class="id-suffix">{{ task.id }}</span>
                                        </a>
                                    </h4>
{#                                    {% if not filter and task.dataset %} #}
{#                                        <p>└ dataset #}
{#                                            <a href="{% url app_name|add:':list_perdataset' task.dataset.pk %}"> #}
{#                                                <span class="id-main">{{ task.dataset.name }}</span> #}
{#                                                <span class="id-suffix">{{ task.dataset.id }}</span> #}
{#                                            </a> #}
{#                                        </p> #}
{#                                    {% endif %} #}
                                    {% for saved_task in task.task.all %}
                                        <p>└ manual clustering
                                            <a href="{{ task.get_absolute_url }}">
                                                <span class="id-main">{{ task.name }}</span>
                                                <span class="id-suffix">{{ task.id }}</span>
                                            </a>
                                        </p>
                                    {% endfor %}
                                </div>
                                <div class="column is-2 p-0 is-left is-top">
                                    <span class="tag status status-{{ task.status }}">{{ task.status }}</span>
                                </div>
                                <p class="user"><span class="iconify" data-icon="mdi:account"></span> {{ task.requested_by.username }}</p>
                                <p class="date">
                                    {{ task.requested_on|date:"Y-m-d H:i" }}
                                    {% if task.task_duration %}
                                        {% if task.task_duration.eval == 'short' %}
                                            <span class="tag is-white is-normal has-text-success"
                                            >{{ task.task_duration.delta|fmt_duration }}</span>
                                        {% elif task.task_duration.eval == 'mid' %}
                                            <span class="tag is-white is-normal has-text-warning"
                                            >{{ task.task_duration.delta|fmt_duration }}</span>
                                        {% else %}
                                            <span class="tag is-white is-normal has-text-danger"
                                            >{{ task.task_duration.delta|fmt_duration }}</span>
                                        {% endif %}
                                    {% endif %}
                                </p>
                            </div></li>
                        {% endfor %}
                    </ul>
                </li>
            {% endfor %}
        </ul>
    </div>
</div>

{{ dataset.task_prefixes|json_script:"tasks-tab-manager" }}
<script type="text/javascript"
        id="tasks-tab-manager"
>
    /**
     * when clicking on one of the `.tab-prefix` elements, toggle the
     * group of tasks being displayed based on their "prefix"
     * (aka, the type of task: similarity, regions....)
     */
    const
        prefixList = JSON.parse(document.getElementById('tasks-tab-manager').textContent),
        tabIdArray = prefixList.map(x => `#task-tab-${x}`),
        tabElArray = document.querySelectorAll(".tab-prefix"),
        taskGroupArray = document.querySelectorAll(".task-group"),
        getPrefixFromTabId = (tabId) =>
            prefixList.filter(x => tabId ===`task-tab-${x}`)[0],
        switchActiveTab = (el) =>
            tabElArray.forEach(tabEl =>
                tabEl.id === el.id
                ? tabEl.classList.add("is-active")
                : tabEl.classList.remove("is-active")),
        switchTabGroup = (el) => {
            let prefix = getPrefixFromTabId(el.id);
            console.log("switchTabGroup", el.id, prefix);
            taskGroupArray.forEach(taskGroup =>
                taskGroup.id === `${prefix}-tasks`
                ? taskGroup.classList.remove("is-hidden")
                : taskGroup.classList.add("is-hidden")); },
        onClick = (e) => {
            switchActiveTab(e.currentTarget);
            switchTabGroup(e.currentTarget);
        };

    tabElArray.forEach((tabEl) =>
        tabEl.addEventListener("click", onClick));
    window.onbeforeunload = (e) =>
        tabElArray.forEach((tabEl) =>
            tabEl.removeEventListener("click", onClick));
</script>
{% endblock %}
