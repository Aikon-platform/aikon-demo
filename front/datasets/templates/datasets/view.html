{% extends "demowebsite/base.html" %}
{% load shared_tags %}

{% block title %}Dataset {{ dataset.id }}{% endblock %}

{% block content %}
<div class="centerwrap">
    <h1 class="is-title is-size-2 py-3">
        <span class="id-main">Dataset {{ dataset.name }}</span>
        <span class="id-suffix">{{ dataset.id }}</span></h1>

    <div class="">
        <h2>Dataset contents</h2>
        <div>
            <p>Format: {{ dataset.format }}</p>
            <p>Contents: {{ dataset.documents|length }}
                document{% if dataset.documents|length > 1 %}s{% endif %},
               {{ dataset.image_count }} images.
            </p>
            <ul>{% for document in dataset.documents %}
                <li>{{ document }}{{ document.src }}</li>
            {% endfor %}</ul>
            <p>Documents for api {{ dataset.documents_for_api }}</p>
            <p>Tree: {{ dataset.documents.0.document_tree }}</p>
        </div>
    </div>

    <div class="">
        <h2>Applied tasks ({{ dataset.tasks|length }})</h2>
        <div class="tabs is-centered is-normal">
            <ul>
                {% for prefix, tasks in dataset.tasks_by_prefix %}
                    <li id="task-tab-{{ prefix }}"
                        class="tab-prefix
                            {% if dataset.tasks_by_prefix.0.0 == prefix %}
                                is-active
                            {% endif %}"
                    >
                        <a>{{prefix}} ({{ tasks|length }} tasks)</a>
                    </li>
                {% endfor %}
            </ul>
        </div>
        <!-- TODO find a better way to style than inline CSS -->
        <ul style="list-style: none;
                   padding-left: 0;
                   margin-bottom: 0;
                   margin-top: 0;"
        >
            {% for prefix, tasks in dataset.tasks_by_prefix %}
                <li id="{{prefix}}-tasks"
                    class="task-group
                        {% if dataset.tasks_by_prefix.0.0 != prefix %}
                            is-hidden
                        {% endif %}"
                >
                    {#<h3>{{prefix}} ({{ tasks|length }} tasks)</h3></dt>#}
{# TODO generalize "tasking/templates/includes/list-item.html" #}
{# so it can be used here ? what's below is just a cheap copy of it #}
                    <div class="task-list">
                        {% for task in tasks %}
                            {% include "includes/list-item.html" %}
                        {% endfor %}
                    </div>
                </li>
            {% endfor %}
        </ul>
    </div>
</div>

{{ dataset.task_prefixes|json_script:"tasks-tab-manager" }}
<script type="text/javascript"
        id="tasks-tab-manager"
>
    /**
     * when clicking on one of the `.tab-prefix` elements, toggle the
     * group of tasks being displayed based on their "prefix"
     * (aka, the type of task: similarity, regions....)
     */
    const
        prefixList = JSON.parse(document.getElementById('tasks-tab-manager').textContent),
        tabIdArray = prefixList.map(x => `#task-tab-${x}`),
        tabElArray = document.querySelectorAll(".tab-prefix"),
        taskGroupArray = document.querySelectorAll(".task-group"),
        getPrefixFromTabId = (tabId) =>
            prefixList.filter(x => tabId ===`task-tab-${x}`)[0],
        switchActiveTab = (el) =>
            tabElArray.forEach(tabEl =>
                tabEl.id === el.id
                ? tabEl.classList.add("is-active")
                : tabEl.classList.remove("is-active")),
        switchTabGroup = (el) => {
            let prefix = getPrefixFromTabId(el.id);
            console.log("switchTabGroup", el.id, prefix);
            taskGroupArray.forEach(taskGroup =>
                taskGroup.id === `${prefix}-tasks`
                ? taskGroup.classList.remove("is-hidden")
                : taskGroup.classList.add("is-hidden")); },
        onClick = (e) => {
            switchActiveTab(e.currentTarget);
            switchTabGroup(e.currentTarget);
        };

    tabElArray.forEach((tabEl) =>
        tabEl.addEventListener("click", onClick));
    window.onbeforeunload = (e) =>
        tabElArray.forEach((tabEl) =>
            tabEl.removeEventListener("click", onClick));
</script>
{% endblock %}
